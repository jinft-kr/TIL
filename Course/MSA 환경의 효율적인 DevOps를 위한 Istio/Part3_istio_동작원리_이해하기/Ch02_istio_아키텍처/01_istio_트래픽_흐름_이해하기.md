### 01. Istio 트래픽 흐름 이해하기

### istio init container
```
➜  kubectl logs server-6cdd6d8fcc-q8wzh -n default -c istio-init                        
W0706 12:53:03.231591   58077 gcp.go:120] WARNING: the gcp auth plugin is deprecated in v1.22+, unavailable in v1.25+; use gcloud instead.
To learn more, consult https://cloud.google.com/blog/products/containers-kubernetes/kubectl-auth-changes-in-gke
2022-07-05T09:20:17.190517Z     info    Istio iptables environment:
ENVOY_PORT=
INBOUND_CAPTURE_PORT=
ISTIO_INBOUND_INTERCEPTION_MODE=
ISTIO_INBOUND_TPROXY_ROUTE_TABLE=
ISTIO_INBOUND_PORTS=
ISTIO_OUTBOUND_PORTS=
ISTIO_LOCAL_EXCLUDE_PORTS=
ISTIO_EXCLUDE_INTERFACES=
ISTIO_SERVICE_CIDR=
ISTIO_SERVICE_EXCLUDE_CIDR=
ISTIO_META_DNS_CAPTURE=
INVALID_DROP=

2022-07-05T09:20:17.190599Z     info    Istio iptables variables:
PROXY_PORT=15001
PROXY_INBOUND_CAPTURE_PORT=15006
PROXY_TUNNEL_PORT=15008
PROXY_UID=1337
PROXY_GID=1337
INBOUND_INTERCEPTION_MODE=REDIRECT
INBOUND_TPROXY_MARK=1337
INBOUND_TPROXY_ROUTE_TABLE=133
INBOUND_PORTS_INCLUDE=*
INBOUND_PORTS_EXCLUDE=15090,15021,15020
OUTBOUND_IP_RANGES_INCLUDE=*
OUTBOUND_IP_RANGES_EXCLUDE=
OUTBOUND_PORTS_INCLUDE=
OUTBOUND_PORTS_EXCLUDE=
KUBE_VIRT_INTERFACES=
ENABLE_INBOUND_IPV6=false
DNS_CAPTURE=false
DROP_INVALID=false
CAPTURE_ALL_DNS=false
DNS_SERVERS=[],[]
OUTPUT_PATH=
NETWORK_NAMESPACE=
CNI_MODE=false
EXCLUDE_INTERFACES=

2022-07-05T09:20:17.190989Z     info    Writing following contents to rules file: /tmp/iptables-rules-1657012817190699579.txt1081852889
* nat
-N ISTIO_INBOUND
-N ISTIO_REDIRECT
-N ISTIO_IN_REDIRECT
-N ISTIO_OUTPUT
-A ISTIO_INBOUND -p tcp --dport 15008 -j RETURN
-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001
-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006 # 15006 port로 in redirect를 하자
-A PREROUTING -p tcp -j ISTIO_INBOUND
-A ISTIO_INBOUND -p tcp --dport 22 -j RETURN
-A ISTIO_INBOUND -p tcp --dport 15090 -j RETURN
-A ISTIO_INBOUND -p tcp --dport 15021 -j RETURN
-A ISTIO_INBOUND -p tcp --dport 15020 -j RETURN
-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT
-A OUTPUT -p tcp -j ISTIO_OUTPUT
-A ISTIO_OUTPUT -o lo -s 127.0.0.6/32 -j RETURN
-A ISTIO_OUTPUT -o lo ! -d 127.0.0.1/32 -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -o lo ! -d 127.0.0.1/32 -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN
-A ISTIO_OUTPUT -j ISTIO_REDIRECT
COMMIT
2022-07-05T09:20:17.191034Z     info    Running command: iptables-restore --noflush /tmp/iptables-rules-1657012817190699579.txt1081852889
2022-07-05T09:20:17.328864Z     info    Writing following contents to rules file: /tmp/ip6tables-rules-1657012817328764818.txt4260431025

2022-07-05T09:20:17.328952Z     info    Running command: ip6tables-restore --noflush /tmp/ip6tables-rules-1657012817328764818.txt4260431025
2022-07-05T09:20:17.330869Z     info    Running command: iptables-save 
2022-07-05T09:20:17.334304Z     info    Command output: 
# Generated by iptables-save v1.8.4 on Tue Jul  5 09:20:17 2022
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:ISTIO_INBOUND - [0:0]
:ISTIO_IN_REDIRECT - [0:0]
:ISTIO_OUTPUT - [0:0]
:ISTIO_REDIRECT - [0:0]
-A PREROUTING -p tcp -j ISTIO_INBOUND
-A OUTPUT -p tcp -j ISTIO_OUTPUT
-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 22 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN
-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT
-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006
-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN
-A ISTIO_OUTPUT -j ISTIO_REDIRECT
-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001
COMMIT
# Completed on Tue Jul  5 09:20:17 2022
```
isito 쪽에 data가 들어왔을 때 15006 port랑 15001 port를 지나감
15006 port : inbound port
15001 port : outbound port 
iptable을 통해 istio proxy가 pod에 들어오는 traffic을 가로챔


실제로 listen하고 있는 port 확인
➜  envoy kubectl exec -it server-6cdd6d8fcc-q8wzh -n default -c istio-proxy -- sh  
istio proxy에는 다양한 networking tool이 설치되어있음
netstat -anr
```
$ netstat -anr
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         10.10.38.1      0.0.0.0         UG        0 0          0 eth0
10.10.38.0      10.10.38.1      255.255.255.0   UG        0 0          0 eth0
10.10.38.1      0.0.0.0         255.255.255.255 UH        0 0          0 eth0
```
ss # socket에 대한 정보 보여주는
```
$ ss -ltp
State                   Recv-Q                  Send-Q                                   Local Address:Port                                    Peer Address:Port                  Process                                               
LISTEN                  0                       1024                                           0.0.0.0:15006                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=37))                       
LISTEN                  0                       1024                                           0.0.0.0:15006                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=36))                       
LISTEN                  0                       1024                                           0.0.0.0:15021                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=24))                       
LISTEN                  0                       1024                                           0.0.0.0:15021                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=23))                       
LISTEN                  0                       1024                                           0.0.0.0:15090                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=22))                       
LISTEN                  0                       1024                                           0.0.0.0:15090                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=21))                       
LISTEN                  0                       1024                                         127.0.0.1:15000                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=18))                       
LISTEN                  0                       1024                                           0.0.0.0:15001                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=35))                       
LISTEN                  0                       1024                                           0.0.0.0:15001                                        0.0.0.0:*                      users:(("envoy",pid=16,fd=34))                       
LISTEN                  0                       1024                                         127.0.0.1:15004                                        0.0.0.0:*                      users:(("pilot-agent",pid=1,fd=14))                  
LISTEN                  0                       1024                                                 *:15020                                              *:*                      users:(("pilot-agent",pid=1,fd=7))                   
LISTEN                  0                       511                                                  *:3000                                               *:*                                                                           
```
pilot-agent : 계속 istio deamon이랑 통신
envoy-proxy


inbound outbound?

